{% extends "layout.html.twig" %}

{% block title %}Connexion - SnapFit{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <h2 class="text-center mb-4">Connexion</h2>

                    {% if error %}
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i> {{ error }}
                    </div>
                    {% endif %}
                    
                    <form method="post" action="index.php?controleur=utilisateur&methode=login" id="loginForm" novalidate>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="mdp" class="form-label">Mot de passe</label>
                            <input type="password" class="form-control" id="mdp" name="mdp" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Se connecter</button>
                    </form>
                </div>
                <div class="card-footer text-center">
                    <small><a href="index.php?controleur=utilisateur&methode=register">Pas encore de compte ?</a></small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('loginForm');
    if (!form) return;

    const fields = {
        email: { 
            element: document.getElementById('email'),
            validate: (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v),
            message: 'Veuillez entrer un email valide'
        },
        mdp: { 
            element: document.getElementById('mdp'),
            validate: (v) => v.length >= 1,
            message: 'Le mot de passe est requis'
        }
    };

    Object.keys(fields).forEach(key => {
        const field = fields[key];
        if (!field.element) return;
        field.element.addEventListener('blur', () => validateField(key));
        field.element.addEventListener('input', () => {
            if (field.element.classList.contains('is-invalid')) validateField(key);
        });
    });

    function validateField(key) {
        const field = fields[key];
        const value = field.element.value.trim();
        const isValid = field.validate(value);
        
        const existingFeedback = field.element.parentNode.querySelector('.invalid-feedback');
        if (existingFeedback) existingFeedback.remove();

        if (isValid) {
            field.element.classList.remove('is-invalid');
            field.element.classList.add('is-valid');
        } else {
            field.element.classList.remove('is-valid');
            field.element.classList.add('is-invalid');
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = field.message;
            field.element.parentNode.appendChild(feedback);
        }
        return isValid;
    }

    form.addEventListener('submit', function(e) {
        let allValid = true;
        Object.keys(fields).forEach(key => {
            if (!validateField(key)) allValid = false;
        });
        if (!allValid) {
            e.preventDefault();
            const firstInvalid = form.querySelector('.is-invalid');
            if (firstInvalid) firstInvalid.focus();
        }
    });
});
</script>
{% endblock %}
